# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
---
name: sync-resource-types

# This workflow automatically syncs default resource type definitions from the resource-types-contrib repository
# It runs on a schedule and can be triggered manually for testing

on:
  schedule:
    # Run daily at 2 AM UTC to check for updates
    - cron: "0 2 * * *"
  # workflow_dispatch: # Uncomment for testing, comment out for production
  #   inputs:
  #     dry_run:
  #       description: "Dry run (don't create PR, just show what would be synced)"
  #       required: false
  #       default: "false"
  #       type: choice
  #       options:
  #         - "true"
  #         - "false"

# Prevent concurrent sync runs
concurrency:
  group: resource-type-sync
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write

jobs:
  sync:
    # Only run on the main repository, not forks
    if: github.repository == 'kachawla/radius'
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout Radius repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          pip install pyyaml requests
      
      - name: Run resource type sync
        id: sync
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SOURCE_REPO: radius-project/resource-types-contrib
          CONFIG_FILE: .github/resource-type-sync-config.yaml
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          python .github/scripts/sync-resource-types.py
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet deploy/manifest/built-in-providers/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
            git diff --stat deploy/manifest/built-in-providers/
          fi
      
      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true' && env.DRY_RUN == 'false'
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7.0.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Sync default resource types from resource-types-contrib"
          branch: sync/resource-types-${{ github.run_number }}
          delete-branch: true
          title: "Sync resource types from resource-types-contrib"
          body: |
            This PR automatically syncs default resource type definitions from the [resource-types-contrib](https://github.com/radius-project/resource-types-contrib) repository.
            
            ## Changes
            
            ${{ steps.sync.outputs.changes }}
            
            ## Verification
            
            - [ ] Resource type manifests follow the proper format
            - [ ] All required fields are present
            - [ ] No sensitive data is included
            
            This PR was automatically generated by the resource type sync workflow.
            
            /cc @radius-project/maintainers
          labels: |
            resource-types
            sync
            automated
          draft: false
      
      - name: Summary
        if: always()
        run: |
          echo "## Resource Type Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "✅ Changes detected and PR created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
            git diff --name-only deploy/manifest/built-in-providers/ >> $GITHUB_STEP_SUMMARY || true
          else
            echo "ℹ️ No changes detected - resource types are up to date" >> $GITHUB_STEP_SUMMARY
          fi

# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
---
name: sync-resource-types

on:
  schedule:
    # Run weekly on Sunday at midnight UTC
    - cron: "0 0 * * 0"
  workflow_dispatch: # Enable during development only
    inputs:
      source_repo:
        description: "Source repository (owner/repo)"
        required: false
        default: "kachawla/resource-types-contrib"
      source_branch:
        description: "Source branch"
        required: false
        default: "main"
      target_dir:
        description: "Target directory in Radius repo"
        required: false
        default: "deploy/manifest/built-in-providers/dev"
      dry_run:
        description: "Perform dry run (no changes)"
        required: false
        default: "false"

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    # Only run on the main repository, not forks
    if: github.repository == 'kachawla/radius'
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Radius repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          path: radius

      - name: Checkout resource-types-contrib repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ github.event.inputs.source_repo || 'kachawla/resource-types-contrib' }}
          ref: ${{ github.event.inputs.source_branch || 'main' }}
          path: resource-types-contrib

      - name: Setup Go
        uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed # v5.1.0
        with:
          go-version-file: radius/go.mod
          cache-dependency-path: radius/go.sum

      - name: Determine source directory
        id: source-dir
        run: |
          # Find the manifests directory in resource-types-contrib
          if [ -d "resource-types-contrib/manifests" ]; then
            echo "path=resource-types-contrib/manifests" >> $GITHUB_OUTPUT
          elif [ -d "resource-types-contrib/types" ]; then
            echo "path=resource-types-contrib/types" >> $GITHUB_OUTPUT
          else
            # Default to root if no standard directory found
            echo "path=resource-types-contrib" >> $GITHUB_OUTPUT
          fi

      - name: Run sync tool
        id: sync
        working-directory: radius
        run: |
          TARGET_DIR="${{ github.event.inputs.target_dir || 'deploy/manifest/built-in-providers/dev' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          
          ARGS="--source ../${{ steps.source-dir.outputs.path }} --target ${TARGET_DIR} --verbose"
          
          if [ "$DRY_RUN" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          
          echo "Running: go run ./hack/sync-resource-types/main.go $ARGS"
          
          # Capture exit code
          if go run ./hack/sync-resource-types/main.go $ARGS; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 2 ]; then
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "No changes detected"
            else
              echo "Sync failed with exit code $EXIT_CODE"
              exit $EXIT_CODE
            fi
          fi

      - name: Check for changes
        id: check-changes
        if: github.event.inputs.dry_run != 'true'
        working-directory: radius
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No file changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "File changes detected"
            git diff --stat
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.changed == 'true' && github.event.inputs.dry_run != 'true'
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7.0.5
        with:
          path: radius
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Automated: Sync resource types from resource-types-contrib"
          title: "Automated: Sync resource types from resource-types-contrib"
          body: |
            ## Description
            
            This PR was automatically generated by the resource type sync workflow.
            
            **Source Repository:** ${{ github.event.inputs.source_repo || 'kachawla/resource-types-contrib' }}
            **Source Branch:** ${{ github.event.inputs.source_branch || 'main' }}
            **Target Directory:** ${{ github.event.inputs.target_dir || 'deploy/manifest/built-in-providers/dev' }}
            
            ## Changes
            
            The following resource type manifests have been updated to stay in sync with resource-types-contrib:
            
            ```
            ${{ steps.sync.outputs.summary }}
            ```
            
            ## Validation
            
            - [ ] Review the changes to ensure they are expected
            - [ ] Verify that all manifests are valid
            - [ ] Run local tests to ensure no breaking changes
            
            ## Related Links
            
            - [resource-types-contrib repository](https://github.com/${{ github.event.inputs.source_repo || 'kachawla/resource-types-contrib' }})
            - [Sync tool documentation](../hack/sync-resource-types/README.md)
          branch: automated/sync-resource-types
          delete-branch: true
          labels: |
            automated
            resource-types
            sync

      - name: Summary
        if: always()
        run: |
          echo "## Sync Resource Types Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "**Mode:** Dry Run (no changes made)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** Actual Sync" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**Source:** ${{ github.event.inputs.source_repo || 'kachawla/resource-types-contrib' }} @ ${{ github.event.inputs.source_branch || 'main' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ github.event.inputs.target_dir || 'deploy/manifest/built-in-providers/dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-changes.outputs.changed }}" = "true" ]; then
            echo "✅ Changes detected and committed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.sync.outputs.has_changes }}" = "false" ]; then
            echo "✅ No changes needed - manifests are in sync" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ Sync completed" >> $GITHUB_STEP_SUMMARY
          fi
